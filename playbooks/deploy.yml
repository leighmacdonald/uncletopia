---
- name: Install Team Fortress 2
  hosts: tf2
  tasks:
    - name: srcds-fw-enable
      become: true
      ansible.builtin.ufw:
        rule: allow
        port: "{{ srcds_base_port + (loop0 * 10) }}"
        proto: udp
      loop: "{{ services }}"
      loop_control:
        index_var: loop0
      when: ansible_distribution == 'Ubuntu'

    - name: stv-fw-enable
      become: true
      ansible.builtin.ufw:
        rule: allow
        port: "{{ srcds_base_port + (loop0 * 10) + 1 }}"
        proto: udp
      loop: "{{ services }}"
      loop_control:
        index_var: loop0
      when: ansible_distribution == 'Ubuntu'

#    - name: srcds-fw-deny
#      become: true
#      ansible.builtin.ufw:
#        rule: deny
#        port: "{{ srcds_base_port + (loop0 * 10) }}"
#        proto: udp
#      loop: "{{ services }}"
#      loop_control:
#        index_var: loop0
#      when: ansible_distribution == 'Ubuntu' and srcds_use_sdr

    - name: srcds-fw-client-outbound
      become: true
      ansible.builtin.ufw:
        rule: allow
        port: "{{ srcds_base_port + (loop0 * 10) + 2 }}"
        proto: udp
        direction: out
      loop: "{{ services }}"
      loop_control:
        index_var: loop0
      when: ansible_distribution == 'Ubuntu'

    - name: cron-srcds
      become: true
      ansible.builtin.cron:
        name: "tf2-restart-{{ item.server_name_short }}"
        weekday: "*"
        minute: "0"
        hour: "6"
        job: "systemctl restart srcds-{{ item.server_name_short }}"
      loop: "{{ services }}"
      loop_control:
        index_var: loop0
      when: ansible_distribution == 'Ubuntu'
      tags: cron

