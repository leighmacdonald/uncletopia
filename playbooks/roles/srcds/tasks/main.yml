---
#- name: Create srcds root
#  ansible.builtin.file:
#    path: ~/steamcmd
#    state: directory
#    mode: "0755"
#
#- name: steamcmd
#  unarchive:
#    src: https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz
#    dest: ~/steamcmd
#    remote_src: yes

- name: download
  command:
    cmd: ./steamcmd.sh +force_install_dir ../srcds-{{ item.server_name_short }} +login anonymous +app_update 232250 +quit
    chdir: ~/steamcmd
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: Install a list of packages
  become: true
  ansible.builtin.apt:
    pkg:
      - lib32z1
      - libncurses5:i386
      - libbz2-1.0:i386
      - lib32gcc-s1
      - lib32stdc++6
      - libtinfo5:i386
      - libcurl3-gnutls:i386
      - libsdl2-2.0-0:i386
      - libncurses5:i386
      - libtinfo5:i386
      - libcurl4:i386
      - libstdc++6:i386
      - libcurl4-gnutls-dev:i386

- name: Build sourcemod
  ansible.builtin.include_role:
    name: sourcemod

- name: Copy sourcemod distribution to /tf
  ansible.posix.synchronize:
    src: /home/tf2server/build_sourcemod/
    dest: /home/tf2server/srcds-{{ item.server_name_short }}/tf/
    recursive: true
  loop: "{{ services }}"
  # Perform the copy from the *remote* sourcemod build output
  delegate_to: "{{ inventory_hostname }}"

- name: Copy navmeshes /tf/maps/
  ansible.builtin.copy:
    src: "{{ role_path }}/files/navmeshes/"
    dest: /home/tf2server/srcds-{{ item.server_name_short }}/tf/maps/
  loop: "{{ services }}"
  # Perform the copy from the *remote* sourcemod build output
  #delegate_to: "{{ inventory_hostname }}"

- name: /tf/mapcycle.txt
  ansible.builtin.template:
    src: mapcycle.txt.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/mapcycle.txt
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: /tf/item_whitelist.txt
  ansible.builtin.template:
    src: item_whitelist.txt.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/item_whitelist.txt
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: /tf/addons/sourcemod/configs/maplists.cfg
  ansible.builtin.template:
    src: maplists.cfg.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/addons/sourcemod/configs/maplists.cfg
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: /tf/cfg/autoexec.cfg
  ansible.builtin.template:
    src: autoexec.cfg.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/cfg/autoexec.cfg
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: /tf/cfg/server.cfg
  ansible.builtin.template:
    src: server.cfg.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/cfg/server.cfg
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: /tf/cfg/motd.cfg
  ansible.builtin.template:
    src: motd.txt.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/cfg/motd.txt
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: /tf/addons/sourcemod/configs/core.cfg
  ansible.builtin.template:
    src: core.cfg.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/addons/sourcemod/configs/core.cfg
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: /tf/addons/sourcemod/configs/discord.cfg
  ansible.builtin.template:
    src: discord.cfg.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/addons/sourcemod/configs/discord.cfg
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: /tf/addons/sourcemod/configs/danepve.cfg
  ansible.builtin.template:
    src: danepve.cfg.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/addons/sourcemod/configs/danepve.cfg
    mode: 0755
  loop: "{{ services }}"
  when: item.config == 'pve'
  loop_control:
    index_var: loop0

- name: /tf/cfg/sourcemod/gbans.cfg
  ansible.builtin.template:
    src: gbans.cfg.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/cfg/sourcemod/gbans.cfg
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: /tf/cfg/sourcemod/basevotes.cfg
  ansible.builtin.template:
    src: basevotes.cfg.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/cfg/sourcemod/basevotes.cfg
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: /tf/cfg/sourcemod/funvotes.cfg
  ansible.builtin.template:
    src: funvotes.cfg.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/cfg/sourcemod/funvotes.cfg
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: /tf/cfg/sourcemod/mapchooser.cfg
  ansible.builtin.template:
    src: mapchooser.cfg.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/cfg/sourcemod/mapchooser.cfg
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: /tf/cfg/sourcemod/nativevotes.cfg
  ansible.builtin.template:
    src: nativevotes.cfg.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/cfg/sourcemod/nativevotes.cfg
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: /tf/cfg/sourcemod/sigsegv_convars.cfg
  ansible.builtin.template:
    src: sigsegv_convars.cfg.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/cfg/sourcemod/sigsegv_convars.cfg
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: /tf/cfg/sourcemod/randomcycle.cfg
  ansible.builtin.template:
    src: randomcycle.cfg.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/cfg/sourcemod/randomcycle.cfg
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: /tf/cfg/sourcemod/rtv.cfg
  ansible.builtin.template:
    src: rtv.cfg.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/cfg/sourcemod/rtv.cfg
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: /tf/cfg/sourcemod/sourcemod.cfg
  ansible.builtin.template:
    src: sourcemod.cfg.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/cfg/sourcemod/sourcemod.cfg
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: /tf/cfg/sourcemod/stac.cfg
  ansible.builtin.template:
    src: stac.cfg.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/cfg/sourcemod/stac.cfg
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: /tf/cfg/sourcemod/networktools.cfg
  ansible.builtin.template:
    src: networktools.cfg.j2
    dest: ~/srcds-{{ item.server_name_short }}/tf/cfg/sourcemod/networktools.cfg
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: /tf/cfg/sourcemod/discord_accelerator.cfg
  ansible.builtin.template:
    src: discord_accelerator.cfg.j2
    dest: "~/srcds-{{ item.server_name_short }}/tf/cfg/sourcemod/discord_accelerator.cfg"
    mode: 0755
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

- name: Generate /entry.sh
  ansible.builtin.template:
    src: "entry.sh.j2"
    dest: "~/srcds-{{ item.server_name_short }}/entry.sh"
    mode: 0775
  loop: "{{ services }}"
  loop_control:
    index_var: loop0

