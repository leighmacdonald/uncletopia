---
- name: create build output dirs
  ansible.builtin.file:
    path: ~/sm-build
    state: directory
    mode: "0770"

- name: Download metamod
  ansible.builtin.get_url:
    url: https://mms.alliedmods.net/mmsdrop/1.11/mmsource-1.11.0-git1145-linux.tar.gz
    dest: ~/sm-build/mm.tar.gz
    mode: "0660"

- name: Extract metamod
  ansible.builtin.unarchive:
    src: ~/sm-build/mm.tar.gz
    dest: ~/sm-build/
    remote_src: true

- name: Remove metamod tarball
  ansible.builtin.file:
    path: sm-build/mm.tar.gz
    state: absent

- name: Download sourcemod
  ansible.builtin.get_url:
    url: https://sm.alliedmods.net/smdrop/1.10/sourcemod-1.10.0-git6542-linux.tar.gz
    dest: ~/sm-build/sm.tar.gz
    mode: "0660"

- name: Extract sourcemod
  ansible.builtin.unarchive:
    src: ~/sm-build/sm.tar.gz
    dest: ~/sm-build
    remote_src: true

- name: Remove sourcemod tarball
  ansible.builtin.file:
    path: sm-build/sm.tar.gz
    state: absent

- name: Copy extensions & plugin sources
  synchronize:
    src: "{{ role_path }}/files/"
    dest: ~/sm-build/

- name: Build plugins
  ansible.builtin.command:
    chdir: ~/sm-build/addons/sourcemod/scripting
    cmd: bash build.sh
    creates: ~/sm-build/addons/sourcemod/plugins/gbans.smx

- name: Create sourcemod release
  community.general.archive:
    path: ~/sm-build/
    dest: ~/ut-sourcemod.tar.gz
    mode: "0660"

- name: Cleanup sourcemod build directory
  ansible.builtin.file:
    state: absent
    path: ~/sm-build
