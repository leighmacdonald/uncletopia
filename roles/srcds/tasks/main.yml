- name: create build directory
  become: true
  ansible.builtin.file:
    path: /build_srcds
    state: directory
    owner: root
    group: root
    mode: '0777'

- name: copy build sources
  ansible.builtin.synchronize:
    src: ./
    dest: /build_srcds/
    archive: false
    recursive: true

- name: Log into DockerHub
  community.docker.docker_login:
    username: "{{ dockerhub.username }}"
    password: "{{ dockerhub.password }}"

- name: build & publish srcds image
  community.docker.docker_image:
    name: leighmacdonald/uncletopia-srcds
    tag: awx
    source: build
    force_tag: true
    push: true
    force_source: true
    build:
      nocache: true
      pull: true
      rm: true
      dockerfile: /build_srcds/Dockerfile
      path: /build_srcds/
    state: present
